## V8的前世今生

V8是JavaScript渲染引擎，在运行JavaScript之前，相比其他的JavaScript的引擎转换成字节码或解释执行，**V8将其编译成原生机器码**（IA-32, x86-64, ARM, or MIPS CPUs） 并且使用了内联缓存 等方法来提高性能。 V8可以独立运行，也可以嵌入 C++应用程序中运行。 

V8的出现是为了更快速的解析和执行JavaScript脚本。在Node中也采用了该引擎。

## 渲染引擎和网页渲染

### 编程分类

编程语言分为编译型语言和解释型语言，编译型语言是在执行前进行完全的编译，而解释型语言是一边编译一边执行，很明显解释型语言的执行速度会慢很多，我们使用的javascript就是一种解释型语言，支持动态类型、弱类型、基于原型的语言，内置支持类型。 

### 渲染引擎

>渲染引擎就是将 HTML、CSS、JavaScript等文本或图片等信息转换成图像结果的转换程序。

比如著名的有 Webkit (safari、Chrome、Andrild浏览器)

Webkit 内部结构大体如下：

<img src="https://gitee.com/youngstory/images/raw/master/img/202110200846659.png" alt="image-20211020084659531"  />

由上图可知，**WebKit主要有操作系统、WebCore 、WebKit嵌入式接口和第三方库组成。**

1. 操作系统 ：是管理和控制计算机硬件与软件资源的计算机程序，是直接运行在裸机上的最基本的系统软件。
2. WebCore：本部分包含各个浏览器使用的共享部分，包括HTML解析器、CSS解析器、DOM和SVG等。JavaScriptCore是WebKit的默认引擎，在谷歌系列产品中被替换为V8引擎。WebKit Ports是WebKit中的非共享部分。
3. Webkit 嵌入式接口： 该接口主要供浏览器调用，与移植密切相关，不同的移植有不同的接口规范。
4. 第三方库：主要是诸如图形库、网络库、视频库、数据存储库等第三方库。、

### 网页渲染流程解析

1. 从输入URL到生成DOM树
   * 地址栏输入URL，webkit调用资源加载器加载相应资源；
   * 加载器依赖网路模块建立连接，发送请求并接收答复。
   * Webkit 接收各种网页或者资源数据，其中某些资源可能生成同步或异步获取；
   * 网页交给HTML解析器转变为词语；
   * 解释器根据词语构建节点，形成DOM树；
   * 如果节点是JavaScript代码，调用JavaScript引擎解释并执行；
   * JavaScript代码可能会修改DOM树结构；
   * 如果节点依赖其他资源，如图片、视频等，调用资源加载器加载它们，但这些是异步加载的，不会阻碍当前DOM树继续创建；如果是JavaScript资源URL（没有标记异步方式），则需要停止当前DOM树创建，直到JavaScript加载并被JavaScript引擎执行后才继续DOM树的创建。
2. 从DOM树到构建webkit绘图上下文
   * CSS文件被css解释器解释成内部表示；
   * CSS解释器完成工作后，在DOM树上附加样式信息，生成RenderObject树；
   * RenderObject节点在创建的同时，WebKit会根据网页层次结构构建RenderLayer树，同时构建一个虚拟绘图上下文。
3. 绘图上下文内容并呈现图像内容 
   * 绘图上下文是一个与平台无关的抽象类，它将每个绘图操作桥接到不同的具体实现类，也就是绘图具体实现类；
   * 绘图实现类也可能有简单的实现，也可能有复杂的实现，软件渲染、硬件渲染、合成渲染等；
   * 绘图实现类将2D图形库或者3D图形库绘制结果保存，交给浏览器界面进行展示。

## V8引擎

工作方式：

<img src="https://gitee.com/youngstory/images/raw/master/img/202110200859639.png" alt="image-20211020085920548" style="zoom:80%;" />

在这个过程中，将JavaScript代码编译成抽象语法树再转化成字节码，通过解释器来执行，并通过JIT工具将部分字节码转化成可直接执行的本地代码。放弃了在字节码阶段可以进行的一些性能优化，但保证了执行速度。虽然少了生成字节码这一阶段的性能优化，但极大减少了转换时间。

