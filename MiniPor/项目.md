# 功能实现

## 产品详情页

1. 绑定跳转事件  设置data-id 

   ``` 
    <view wx:for="{{products}}" wx:key="index" class="item" data-id="{{item.id}}" bindtap="toDetail">
   ```

2. 跳转事件方法   跳转地址 加商品id

   ``` 
   toDetail(e){
        let id= e.currentTarget.dataset.id
        wx.navigateTo({
          url: '../goods/goods?id='+id,
        })
     } ,
   ```

3. 通过option 来接收传过来的 id  

   ``` 
   onLoad: function (options) {
         this.setData({
           id:options.id
         })
     },
   ```

4. 拿到商品id 值，调用商品详情页接口 渲染页面 。

   ``` 
    onshow 页面发生变动就请求刷新一次
    onShow: function () {
         let id = this.data.id
         wx.request({
           url: 'http://localhost:3000/api/goodsdetail/'+id,
           header: {
             'content-type': 'application/json' // 默认值
           },
           success:res=>{
             console.log(res);
             this.setData({
               goodsOne:res.data.data[0]
             })
           }
         })
     },
   // 商品详情页接口 
   router.get('/api/goodsdetail/:id',apiController.goodsDetail);
   
    static async goodsDetail(ctx){
           let id = ctx.params.id;  
           let results = await articleModel.findAll({where:{id}})
           if (results.length > 0) {
               ctx.body = {
                   code: 1,
                   msg: "OK",
                   data: results,
               };
           } else {
               ctx.body = {
                   code: 1,
                   msg: "没有查询到内容",
                   data: []
               };
           }
       }
       
   //  渲染页面出错 ，由于图片加载时间过长 。  
    给view  添加 wx:if 隐藏  布尔值, 等ajax数据加载完图片 再给view显示出来 
    <view wx:if="{{isFlag}}">
    this.setData({
               goodsOne:res.data.data[0],
               isFlag:true
   
             })
   ```

## 微信授权登录

### 用户信息

相关api : `wx.getUserProfile(Object object)`

相关文档：[wx.getUserProfile(Object object) | 微信开放文档 (qq.com)](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/user-info/wx.getUserProfile.html)

页面发生点击时，才可以调用该api，每次请求调用都会弹出框，让用户同意 获取用户信息

核心代码：

```js
// 通过 userInfo.nickName 获取用户昵称
// 通过 userInfo.avatarUrl 获取用户头像
getUserProfile(e) {
   
    wx.getUserProfile({
      desc: '用于完善会员资料', 
      success: (res) => {
        this.setData({
          userInfo: res.userInfo,
          hasUserInfo: true
        })
      }
    })
}
```

用户退出登录时，把userInfo 信息清空即可。

### 本地缓存

1. 在获取用户信息的 success 回调函数中`wx.setStorageSync('user', anydata )` 存储数据 

2. 在onLoad() 函数中进行 `wx.getStorageSync('user' )` 获取用户信息 

